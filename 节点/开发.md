# 节点开发

本节介绍 Python 节点的生命周期、数据获取与处理逻辑，以及标准的返回结果示例，帮助开发者快速实现自定义节点。

---

## 1. 节点生命周期

一个节点的典型生命周期包括以下几个阶段：

1. **初始化**：系统实例化节点对象，执行 `__init__` 方法，完成成员变量初始化。在此阶段可以初始化缓存功能。
2. **获取输入**：系统调用 `get_node_input` 方法，将上游节点或用户输入的数据传递给节点。
3. **获取配置**：系统调用 `get_user_input` 方法，将 config.json 中的配置项传递给节点。
4. **执行主逻辑**：系统调用 `execute` 方法，节点根据输入和配置执行核心处理。
5. **返回结果**：`execute` 方法返回结果，系统将其分发给下游节点或用于展示。

### 1.1 缓存功能

节点支持Redis缓存功能，可以在初始化时通过 `cache` 参数启用：

```python
class MainNode:
    def __init__(self, cache=None):
        self.input_data = {}   # 存储输入参数
        self.config = {}       # 存储配置项
        self.cache = cache     # 缓存对象，可选参数
```

缓存对象提供以下方法：

- `set(key, value, ex=None)`：设置缓存值，`ex` 为过期时间（秒）
- `get(key)`：获取缓存值
- `delete(key)`：删除缓存项
- `exists(key)`：检查缓存项是否存在
- `flush()`：清空所有缓存

使用示例：

```python
def execute(self):
    # 检查缓存
    cache_key = f"result_{self.input_data.get('数值1')}_{self.input_data.get('数值2')}"
    
    if self.cache and self.cache.exists(cache_key):
        # 从缓存获取结果
        cached_result = self.cache.get(cache_key)
        return {"outputs": {"结果": str(cached_result)}}
    
    # 计算新结果
    num1 = float(self.input_data.get('数值1', 0))
    num2 = float(self.input_data.get('数值2', 0))
    result = num1 + num2
    
    # 存入缓存（设置1小时过期）
    if self.cache:
        self.cache.set(cache_key, result, ex=3600)
    
    return {"outputs": {"结果": result}}
```

---

## 2. 数据获取与处理逻辑

节点通过以下方式获取输入和配置：

```python
class MainNode:
    def __init__(self, cache=None):
        self.input_data = {}   # 存储输入参数
        self.config = {}       # 存储配置项
        self.cache = cache     # 缓存对象，可选参数

    def get_node_input(self, config):
        self.input_data = config  # 获取上游节点输入参数

    def get_user_input(self, config):
        self.config = {item['name']: item['default_value'] for item in config}  # 获取配置项

    def execute(self):
        # 构建缓存键
        cache_key = f"calc_{self.input_data.get('数值1')}_{self.input_data.get('数值2')}_{self.config.get('运算类型')}"
        
        # 检查缓存
        if self.cache and self.cache.exists(cache_key):
            cached_result = self.cache.get(cache_key)
            return {"outputs": cached_result}
        
        # 获取输入值
        num1 = float(self.input_data.get('数值1', 0))
        num2 = float(self.input_data.get('数值2', 0))
        # 获取配置项
        operation = self.config.get('运算类型', 'all')
        
        # 处理逻辑
        result = {
            "加法结果": num1 + num2,
            "减法结果": num1 - num2
        }
        
        # 存入缓存（设置30分钟过期）
        if self.cache:
            self.cache.set(cache_key, result, ex=1800)
        
        return {"outputs": result}
```

---

## 3. 返回结果的标准格式

- `execute` 方法必须返回一个字典，包含 `outputs` 字段。
- `outputs` 字典的 key 必须与 config.json 中 outputs 的 name 字段完全一致。
- 示例：

```python
return {
    "outputs": {
        "加法结果": 10,
        "减法结果": 2
    }
}
```

---

## 4. 调试功能

如果您需要在客户端打印调试信息，可以在 `print` 语句的第一个输出内容前加上 `#` 号：

```python
def execute(self):
    # 调试信息
    print("#", "开始执行节点")
    print("#", f"输入参数: {self.input_data}")
    print("#", f"配置项: {self.config}")
    
    # 正常处理逻辑
    result = self.process_data()
    
    print("#", f"处理结果: {result}")
    return {"outputs": result}
```

**重要说明**：
- 节点执行会忽略以 `#` 开头的行内容
- 这样可以避免调试信息影响正常的节点输出结果
- 调试信息会显示在客户端的调试区域中

---

通过遵循上述生命周期和数据处理规范，开发者可以高效实现功能完备、易于集成的自定义节点。